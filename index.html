<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tachitte</title>
    <!-- Configurações PWA -->
    <link rel="manifest" href="/tachitte/manifest.json">
    <meta name="theme-color" content="#dc2626">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Icones Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Biblioteca para gerar QR Code do Pix -->
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>

    <style>
        /* Estilos personalizados para o PWA */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fef2f2; /* Vermelho pastel claro */
        }
        /* Gradiente de fundo suave para o cabeçalho */
        .header-bg {
            background-color: #dc2626;
        }
        .text-tachitte {
            font-size: 2.5rem;
            text-shadow: 2px 2px #b91c1c;
        }
        /* Estilo para a animação do botão */
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }
        .btn-animate {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        /* Ocultar o scrollbar, mantendo a funcionalidade de rolagem */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
        /* Estilo para o modal */
        .modal {
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }
        .tab-button.active {
            border-bottom: 3px solid #dc2626;
            color: #dc2626;
            font-weight: bold;
        }
        /* Estilos adicionais para o novo layout das abas e imagens */
        .tab-button {
            flex-grow: 1;
            flex-basis: 0;
        }
        .menu-item-image {
            height: 200px; /* Aumenta a altura das imagens */
            object-fit: cover;
        }
        /* Estilos para a seção 'O que são Tachittes?' */
        .about-tachitte {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        .about-tachitte img {
            max-width: 200px;
            height: auto;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        @media (max-width: 768px) {
            .about-tachitte {
                flex-direction: column;
                text-align: center;
            }
        }
        /* Novo estilo para organizar as opções de pagamento no modal */
        .payment-options-container {
            display: grid;
            gap: 1rem;
        }
        .payment-options-container > div {
            border: 1px solid #fca5a5;
            padding: 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }
        .payment-options-container .payment-method-radio:checked + span {
            font-weight: bold;
        }
        .payment-options-container > div.active {
            background-color: #fef2f2;
            border-color: #dc2626;
        }
    </style>
</head>
<body class="bg-red-50 min-h-screen flex flex-col">

    <!-- Cabeçalho -->
    <header class="header-bg text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-3xl font-bold text-white text-tachitte">Tachitte</h1>
            <div class="relative">
                <button id="cart-button" class="p-2 relative rounded-full hover:bg-red-600 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shopping-cart"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></svg>
                    <span id="cart-count" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-600 transform translate-x-1/2 -translate-y-1/2 bg-white rounded-full">0</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Conteúdo Principal -->
    <main class="flex-grow container mx-auto p-4 md:p-8">
        
        <!-- Sobre os Tachittes -->
        <div class="bg-white p-4 rounded-lg shadow-md mb-6">
            <h2 class="text-2xl font-bold mb-2 text-red-600 text-center">O que são Tachittes?</h2>
            <div class="about-tachitte">
                <img src="images/tradicional.png" alt="Tachitte Tradicional" class="w-full md:w-auto h-auto object-cover rounded-md flex-shrink-0">
                <p class="text-red-800 leading-relaxed text-center md:text-left">
                    Descubra o Tachitte, a nossa versão aprimorada do sushi! Mais do que um simples enrolado, o Tachitte é uma experiência completa: <b>maior</b>, <b>mais recheado</b> e irresistivelmente saboroso. Nossa receita base é feita com <b>arroz</b>, <b>alga</b>, <b>cenoura</b> e uma proteína suculenta (<b>peixe</b> ou <b>carne</b>), criando a tela perfeita para as mais variadas combinações de sabores. Venha se surpreender!
                </p>
            </div>
        </div>

        <!-- Opções de Pedido: Retirar ou Entregar -->
        <div class="bg-white p-4 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-bold mb-4 text-red-600 text-center">Escolha a opção de pedido</h2>
            <div class="flex space-x-4">
                <button id="delivery-option" class="flex-1 py-3 px-4 rounded-full border border-red-300 text-red-800 bg-white hover:bg-red-100 transition-colors">
                    Entrega
                </button>
                <button id="pickup-option" class="flex-1 py-3 px-4 rounded-full border border-red-500 text-white bg-red-500 hover:bg-red-600 transition-colors">
                    Retirar
                </button>
            </div>
        </div>
        
        <!-- Mensagem de feedback do usuário -->
        <div id="status-message" class="hidden fixed top-24 right-4 bg-red-500 text-white p-4 rounded-lg shadow-xl z-50"></div>

        <!-- Abas de Navegação -->
        <div class="bg-white rounded-lg shadow-md mb-6">
            <div class="flex border-b border-red-300">
                <button id="salgados-tab" class="tab-button flex-1 py-3 px-4 text-center text-red-800 hover:bg-red-50 transition-colors rounded-tl-lg active">Salgados</button>
                <button id="doces-tab" class="tab-button flex-1 py-3 px-4 text-center text-red-800 hover:bg-red-50 transition-colors">Doces</button>
                <button id="bebidas-tab" class="tab-button flex-1 py-3 px-4 text-center text-red-800 hover:bg-red-50 transition-colors rounded-tr-lg">Bebidas</button>
            </div>
        </div>

        <!-- Conteúdo das Abas -->
        <section id="salgados-menu" class="menu-tab">
            <h2 class="text-2xl font-bold text-red-600 mb-4">Tachittes Salgados</h2>
            <div id="salgados-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Itens salgados serão inseridos aqui pelo JavaScript -->
            </div>
        </section>

        <section id="doces-menu" class="menu-tab hidden">
            <h2 class="text-2xl font-bold text-red-600 mb-4">Tachittes Doces</h2>
            <div id="doces-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Itens doces serão inseridos aqui pelo JavaScript -->
            </div>
        </section>

        <section id="bebidas-menu" class="menu-tab hidden">
            <h2 class="text-2xl font-bold text-red-600 mb-4">Bebidas</h2>
            <div id="bebidas-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Itens de bebidas serão inseridos aqui pelo JavaScript -->
            </div>
        </section>

    </main>
    
    <!-- Aviso de Conteúdo Fictício -->
    <div class="text-center text-xs text-red-400 mt-8 mb-4 px-4">
        Este site, incluindo todos os produtos e o restaurante Tachitte, é fictício e foi criado apenas para fins de demonstração.
    </div>

    <!-- Modal do Carrinho -->
    <div id="cart-modal" class="modal fixed inset-0 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg p-6 shadow-xl w-full max-w-lg overflow-y-auto hide-scrollbar max-h-[90vh]">
            <div class="flex justify-between items-center border-b pb-4 mb-4">
                <h2 class="text-2xl font-bold text-red-900">Seu Carrinho</h2>
                <button id="close-cart-modal" class="text-red-400 hover:text-red-900 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
            </div>
            <div id="cart-items" class="space-y-4">
                <!-- Itens do carrinho serão inseridos aqui -->
            </div>
            <div class="border-t pt-4 mt-4">
                <div class="flex justify-between font-bold text-lg mb-2">
                    <span>Total:</span>
                    <span id="cart-total">R$ 0.00</span>
                </div>
                <button id="checkout-button" class="w-full bg-red-500 text-white py-3 rounded-full font-bold hover:bg-red-600 transition-colors btn-animate">
                    Finalizar Pedido
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Customização do Tachitte -->
    <div id="customize-modal" class="modal fixed inset-0 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg p-6 shadow-xl w-full max-w-lg overflow-y-auto hide-scrollbar max-h-[90vh]">
            <div class="flex justify-between items-center border-b pb-4 mb-4">
                <h2 class="text-2xl font-bold text-red-900">Personalize seu Tachitte</h2>
                <button id="close-customize-modal" class="text-red-400 hover:text-red-900 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
            </div>
            <p class="text-sm text-red-600 mb-4">Selecione até 5 ingredientes para o seu Tachitte customizado.</p>
            <div id="ingredients-list" class="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-6">
                <!-- Ingredientes serão inseridos aqui pelo JavaScript -->
            </div>
            <div class="border-t pt-4">
                <button id="add-custom-tachitte-button" class="w-full bg-red-500 text-white py-3 rounded-full font-bold hover:bg-red-600 transition-colors">
                    Adicionar ao Carrinho
                </button>
            </div>
        </div>
    </div>

    <!-- Novo Modal de Pagamento e Envio -->
    <div id="checkout-modal" class="modal fixed inset-0 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg p-6 shadow-xl w-full max-w-lg overflow-y-auto hide-scrollbar max-h-[90vh]">
            <div class="flex justify-between items-center border-b pb-4 mb-4">
                <h2 class="text-2xl font-bold text-red-900">Finalizar Pedido</h2>
                <button id="close-checkout-modal" class="text-red-400 hover:text-red-900 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <h3 class="font-bold text-red-900 mb-2">Forma de Pagamento</h3>
                    <div class="payment-options-container">
                        <div id="pix-payment-option" class="p-3 border border-red-300 rounded-lg cursor-pointer active">
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="radio" name="payment-method" value="PIX" class="payment-method-radio accent-red-500" checked>
                                <span>PIX</span>
                            </label>
                            <div id="pix-info-container" class="mt-4 space-y-4">
                                <p class="text-center text-sm text-red-600">Escaneie o QR Code ou copie a chave para pagar.</p>
                                <div class="flex flex-col items-center">
                                    <div id="qrcode-pix" class="p-2 bg-white rounded-md"></div>
                                    <button id="copy-pix-key" class="mt-2 text-sm text-white bg-red-500 hover:bg-red-600 py-1 px-3 rounded-full">
                                        Copiar Chave Pix
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="card-payment-option" class="p-3 border border-red-300 rounded-lg cursor-pointer">
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="radio" name="payment-method" value="Cartões" class="payment-method-radio accent-red-500">
                                <span>Cartões</span>
                            </label>
                            <div id="card-sub-options" class="mt-4 space-y-2 pl-4">
                                <h4 class="font-bold text-red-800">Tipo de Cartão</h4>
                                <div class="flex items-center space-x-2">
                                    <input type="radio" name="card-type" value="Crédito" class="card-type-radio accent-red-500" checked>
                                    <span>Crédito</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <input type="radio" name="card-type" value="Débito" class="card-type-radio accent-red-500">
                                    <span>Débito</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <input type="radio" name="card-type" value="Refeição" class="card-type-radio accent-red-500">
                                    <span>Refeição</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <input type="radio" name="card-type" value="Alimentação" class="card-type-radio accent-red-500">
                                    <span>Alimentação</span>
                                </div>
                            </div>
                        </div>
                        <div id="money-payment-option" class="p-3 border border-red-300 rounded-lg cursor-pointer">
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="radio" name="payment-method" value="Dinheiro" class="payment-method-radio accent-red-500">
                                <span>Dinheiro</span>
                            </label>
                            <div id="money-change-options" class="mt-4 space-y-4 pl-4">
                                <h4 class="font-bold text-red-800">Troco para quanto?</h4>
                                <div>
                                    <label for="money-value" class="block text-sm font-medium text-red-900">Valor do dinheiro</label>
                                    <input type="number" id="money-value" class="mt-1 block w-full rounded-md border-red-300 shadow-sm focus:border-red-500 focus:ring-red-500 p-2" placeholder="Ex: 50.00" min="0">
                                </div>
                                <p id="change-value" class="text-sm font-medium text-red-900"></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="delivery-info" class="space-y-4 hidden">
                    <h3 class="font-bold text-red-900">Dados para Entrega</h3>
                    <div>
                        <label for="address" class="block text-sm font-medium text-red-900">Endereço</label>
                        <input type="text" id="address" class="mt-1 block w-full rounded-md border-red-300 shadow-sm focus:border-red-500 focus:ring-red-500 p-2" placeholder="Rua, Número, Bairro">
                    </div>
                    <div>
                        <label for="phone" class="block text-sm font-medium text-red-900">Telefone</label>
                        <input type="tel" id="phone" class="mt-1 block w-full rounded-md border-red-300 shadow-sm focus:border-red-500 focus:ring-red-500 p-2" placeholder="(XX) XXXXX-XXXX">
                    </div>
                </div>
                <div class="border-t pt-4">
                    <button id="send-whatsapp-button" class="w-full bg-red-500 text-white py-3 rounded-full font-bold hover:bg-red-600 transition-colors btn-animate">
                        Enviar Pedido por WhatsApp
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { menuData, settings } from './data.js';

        // --- Funções para Geração do PIX Payload sem biblioteca ---
        // Calcula o CRC16 para o payload do Pix
        function CRC16_CCITT_calc(str) {
            let crc = 0xFFFF;
            for (let i = 0; i < str.length; i++) {
                crc ^= (str.charCodeAt(i) << 8);
                for (let j = 0; j < 8; j++) {
                    crc = (crc & 0x8000) ? (crc << 1) ^ 0x1021 : (crc << 1);
                }
            }
            return (crc & 0xFFFF).toString(16).toUpperCase().padStart(4, '0');
        }

        // Formata o ID do campo e o valor para o padrão EMV
        function formatEMV(id, value) {
            const len = String(value.length).padStart(2, '0');
            return `${id}${len}${value}`;
        }

        // Constrói o payload completo do Pix
        function getPixPayload(amount) {
            const txid = `TXID${Date.now()}`; // Gerando um identificador de transação único
            
            const payload = [
                formatEMV('00', '01'), // Payload Format Indicator
                formatEMV('26', [
                    formatEMV('00', 'br.gov.bcb.pix'), // Merchant Account Information
                    formatEMV('01', settings.pixKey) // Pix Key
                ].join('')),
                formatEMV('52', '0000'), // Merchant Category Code (MCC)
                formatEMV('53', '986'),  // Transaction Currency (BRL)
                formatEMV('54', amount.toFixed(2)), // Transaction Amount
                formatEMV('58', 'BR'), // Country Code
                formatEMV('59', settings.pixName), // Merchant Name
                formatEMV('60', settings.pixCity), // Merchant City
                formatEMV('62', formatEMV('05', txid)), // Transaction ID agora é dinâmico
            ].join('');

            const crc16 = CRC16_CCITT_calc(payload + '6304');
            return payload + '6304' + crc16;
        }
        // --- Fim das funções para Geração do PIX Payload sem biblioteca ---


        // Estado global do app
        const state = {
            cart: [],
            isDelivery: false,
            deliveryFee: settings.deliveryFee
        };

        // Seletores do DOM
        const tachittesList = document.getElementById('salgados-list');
        const docesList = document.getElementById('doces-list');
        const bebidasList = document.getElementById('bebidas-list');
        const cartButton = document.getElementById('cart-button');
        const cartCount = document.getElementById('cart-count');
        const cartModal = document.getElementById('cart-modal');
        const customizeModal = document.getElementById('customize-modal');
        const closeCartModal = document.getElementById('close-cart-modal');
        const closeCustomizeModal = document.getElementById('close-customize-modal');
        const ingredientsList = document.getElementById('ingredients-list');
        const addCustomTachitteButton = document.getElementById('add-custom-tachitte-button');
        const checkoutButton = document.getElementById('checkout-button');
        const deliveryOptionBtn = document.getElementById('delivery-option');
        const pickupOptionBtn = document.getElementById('pickup-option');
        const statusMessage = document.getElementById('status-message');
        const tabButtons = document.querySelectorAll('.tab-button');
        const menuSections = document.querySelectorAll('.menu-tab');
        const checkoutModal = document.getElementById('checkout-modal');
        const closeCheckoutModal = document.getElementById('close-checkout-modal');
        const deliveryInfoDiv = document.getElementById('delivery-info');
        const sendWhatsappButton = document.getElementById('send-whatsapp-button');
        const phoneInput = document.getElementById('phone');
        const addressInput = document.getElementById('address');
        const cardSubOptionsDiv = document.getElementById('card-sub-options');
        const moneyChangeOptionsDiv = document.getElementById('money-change-options');
        const moneyValueInput = document.getElementById('money-value');
        const changeValueP = document.getElementById('change-value');
        const pixInfoContainer = document.getElementById('pix-info-container');
        const qrcodePixDiv = document.getElementById('qrcode-pix');
        const copyPixKeyButton = document.getElementById('copy-pix-key');

        // Elementos de rádio
        const paymentMethodRadios = document.querySelectorAll('.payment-method-radio');


        // Função para mostrar mensagem de feedback
        function showStatusMessage(message, type = 'success') {
            statusMessage.textContent = message;
            statusMessage.classList.remove('hidden', 'bg-red-500', 'bg-green-500');
            statusMessage.classList.add(type === 'success' ? 'bg-red-500' : 'bg-red-500');
            statusMessage.classList.add('animate-slide-in');
            setTimeout(() => {
                statusMessage.classList.remove('animate-slide-in');
                statusMessage.classList.add('animate-slide-out');
                setTimeout(() => {
                    statusMessage.classList.add('hidden');
                    statusMessage.classList.remove('animate-slide-out');
                }, 500);
            }, 3000);
        }

        // Função para renderizar um único item do menu
        function renderMenuItem(item, listElement) {
            const itemHtml = `
                <div class="bg-white rounded-lg shadow-md p-4 flex flex-col justify-between">
                    <div class="flex-shrink-0 mb-4">
                        <img src="${item.img}" alt="${item.name}" class="w-full h-52 object-cover rounded-md mb-4 menu-item-image">
                        <h3 class="text-lg font-bold text-red-900">${item.name}</h3>
                        <p class="text-sm text-red-400 min-h-[40px]">${item.description}</p>
                    </div>
                    <div class="flex items-center justify-between mt-auto">
                        <span class="text-xl font-bold text-red-600">R$ ${item.price.toFixed(2)}</span>
                        <button class="add-to-cart-btn bg-red-500 text-white p-2 rounded-full hover:bg-red-600 transition-colors" data-id="${item.id}" data-custom="${item.isCustom || false}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                        </button>
                    </div>
                </div>
            `;
            listElement.innerHTML += itemHtml;
        }

        // Função para renderizar o menu completo
        function renderMenu() {
            tachittesList.innerHTML = '';
            docesList.innerHTML = '';
            bebidasList.innerHTML = '';
            
            menuData.tachittes.filter(item => item.type === 'salty').forEach(item => renderMenuItem(item, tachittesList));
            menuData.tachittes.filter(item => item.type === 'sweet').forEach(item => renderMenuItem(item, docesList));
            menuData.bebidas.forEach(item => renderMenuItem(item, bebidasList));
        }

        // Função para renderizar os ingredientes no modal de customização
        function renderIngredients() {
            ingredientsList.innerHTML = menuData.ingredientes.map(ing => `
                <label class="flex items-center space-x-2 p-2 border border-red-300 rounded-md cursor-pointer hover:bg-red-50 transition-colors">
                    <input type="checkbox" data-id="${ing.id}" data-name="${ing.name}" class="ing-checkbox rounded text-red-500 focus:ring-red-500">
                    <span class="text-sm">${ing.name}</span>
                </label>
            `).join('');
        }
        
        // Atualiza a visualização do carrinho (itens e total)
        function updateCartView() {
            const cartItemsList = document.getElementById('cart-items');
            const cartTotal = document.getElementById('cart-total');
            cartItemsList.innerHTML = '';
            let total = 0;

            if (state.cart.length === 0) {
                cartItemsList.innerHTML = '<p class="text-red-400 text-center">Seu carrinho está vazio.</p>';
                checkoutButton.disabled = true;
                checkoutButton.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                checkoutButton.disabled = false;
                checkoutButton.classList.remove('opacity-50', 'cursor-not-allowed');

                state.cart.forEach((item, index) => {
                    const price = item.price * item.quantity;
                    total += price;

                    const itemHtml = `
                        <div class="flex items-center justify-between border-b pb-4">
                            <div class="flex items-center space-x-4">
                                <img src="${item.img}" alt="${item.name}" class="w-16 h-16 object-cover rounded-md">
                                <div>
                                    <h4 class="font-bold text-red-900">${item.name}</h4>
                                    ${item.ingredients ? `<p class="text-sm text-red-400">Ingredientes: ${item.ingredients.join(', ')}</p>` : ''}
                                    <span class="text-red-600">R$ ${item.price.toFixed(2)}</span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button class="update-quantity-btn w-6 h-6 rounded-full bg-red-200 text-red-600 flex items-center justify-center" data-index="${index}" data-action="decrease">-</button>
                                <span class="font-bold">${item.quantity}</span>
                                <button class="update-quantity-btn w-6 h-6 rounded-full bg-red-200 text-red-600 flex items-center justify-center" data-index="${index}" data-action="increase">+</button>
                                <button class="remove-from-cart-btn text-red-500 hover:text-red-700 transition-colors" data-index="${index}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                                </button>
                            </div>
                        </div>
                    `;
                    cartItemsList.innerHTML += itemHtml;
                });
            }

            // Adiciona a taxa de entrega se a opção estiver selecionada
            let finalTotal = total;
            const deliveryFeeElement = document.getElementById('delivery-fee-row');
            if (state.isDelivery) {
                finalTotal += state.deliveryFee;
                if (!deliveryFeeElement) {
                    const deliveryFeeHtml = `
                        <div id="delivery-fee-row" class="flex justify-between text-sm text-red-400 mt-2">
                            <span>Taxa de Entrega:</span>
                            <span>R$ ${state.deliveryFee.toFixed(2)}</span>
                        </div>
                    `;
                    cartItemsList.innerHTML += deliveryFeeHtml;
                }
            } else {
                if (deliveryFeeElement) {
                    deliveryFeeElement.remove();
                }
            }

            cartTotal.textContent = `R$ ${finalTotal.toFixed(2)}`;
            cartCount.textContent = state.cart.reduce((sum, item) => sum + item.quantity, 0);
        }

        // Adiciona um item ao carrinho
        function addItemToCart(item) {
            const existingItem = state.cart.find(cartItem => cartItem.id === item.id && !cartItem.ingredients);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                state.cart.push({ ...item, quantity: 1 });
            }
            updateCartView();
            showStatusMessage(`${item.name} adicionado ao carrinho!`);
        }
        
        // Função para alternar entre as abas
        function showTab(tabId) {
            menuSections.forEach(section => {
                section.classList.add('hidden');
            });
            tabButtons.forEach(button => {
                button.classList.remove('active');
            });

            document.getElementById(tabId).classList.remove('hidden');
            document.querySelector(`#${tabId.replace('-menu', '-tab')}`).classList.add('active');
        }
        
        // Função para resetar os campos do formulário
        function resetCheckoutForm() {
            addressInput.value = '';
            phoneInput.value = '';
            moneyValueInput.value = '';
            changeValueP.textContent = '';
            document.querySelector('input[name="payment-method"][value="PIX"]').checked = true;
            
            // Redefine a opção de pedido para Retirar
            state.isDelivery = false;
            pickupOptionBtn.classList.add('border-red-500', 'bg-red-500', 'text-white');
            deliveryOptionBtn.classList.remove('border-red-500', 'bg-red-500', 'text-white');
            pickupOptionBtn.classList.remove('border-red-300', 'bg-white', 'text-red-800');
            deliveryOptionBtn.classList.add('border-red-300', 'bg-white', 'text-red-800');
            
            // Remove a classe 'active' de todos os contêineres de pagamento e adiciona ao PIX
            document.querySelectorAll('.payment-options-container > div').forEach(div => div.classList.remove('active'));
            document.getElementById('pix-payment-option').classList.add('active');
            
            // Esconde todas as sub-opções
            pixInfoContainer.classList.add('hidden');
            cardSubOptionsDiv.classList.add('hidden');
            moneyChangeOptionsDiv.classList.add('hidden');
        }
        
        // Gera o QR Code do Pix
        function generatePixQRCode(amount) {
            const payload = getPixPayload(amount);
            
            // Limpa o container e gera o novo QR Code
            qrcodePixDiv.innerHTML = '';
            new QRCode(qrcodePixDiv, payload);
        }

        // Manipuladores de eventos
        document.addEventListener('click', (e) => {
            // Adicionar ao carrinho
            if (e.target.closest('.add-to-cart-btn')) {
                const button = e.target.closest('.add-to-cart-btn');
                const itemId = button.dataset.id;
                const isCustom = button.dataset.custom === 'true';

                if (isCustom) {
                    renderIngredients();
                    customizeModal.classList.remove('hidden');
                } else {
                    const item = menuData.tachittes.find(i => i.id === itemId) || menuData.bebidas.find(i => i.id === itemId);
                    if (item) {
                        addItemToCart(item);
                    }
                }
            }

            // Abrir e fechar o modal do carrinho
            if (e.target.closest('#cart-button')) {
                updateCartView();
                cartModal.classList.remove('hidden');
            }
            if (e.target.closest('#close-cart-modal')) {
                cartModal.classList.add('hidden');
            }

            // Fechar modal de customização
            if (e.target.closest('#close-customize-modal')) {
                customizeModal.classList.add('hidden');
            }

            // Abrir e fechar o modal de checkout
            if (e.target.closest('#checkout-button')) {
                cartModal.classList.add('hidden');
                if (state.isDelivery) {
                    deliveryInfoDiv.classList.remove('hidden');
                } else {
                    deliveryInfoDiv.classList.add('hidden');
                }
                checkoutModal.classList.remove('hidden');
                // Inicializa o estado do modal de checkout
                const currentTotal = parseFloat(document.getElementById('cart-total').textContent.replace('R$', ''));
                if (document.querySelector('input[name="payment-method"]:checked').value === 'PIX') {
                     generatePixQRCode(currentTotal);
                     pixInfoContainer.classList.remove('hidden');
                     cardSubOptionsDiv.classList.add('hidden');
                     moneyChangeOptionsDiv.classList.add('hidden');
                }
            }
            if (e.target.closest('#close-checkout-modal')) {
                checkoutModal.classList.add('hidden');
                resetCheckoutForm();
            }
            
            // Alterar quantidade no carrinho
            if (e.target.closest('.update-quantity-btn')) {
                const button = e.target.closest('.update-quantity-btn');
                const index = parseInt(button.dataset.index);
                const action = button.dataset.action;
                const item = state.cart[index];

                if (action === 'increase') {
                    item.quantity++;
                } else if (action === 'decrease' && item.quantity > 1) {
                    item.quantity--;
                }
                updateCartView();
            }

            // Remover item do carrinho
            if (e.target.closest('.remove-from-cart-btn')) {
                const button = e.target.closest('.remove-from-cart-btn');
                const index = parseInt(button.dataset.index);
                state.cart.splice(index, 1);
                updateCartView();
                showStatusMessage('Item removido do carrinho.');
            }

            // Adicionar tachitte customizado ao carrinho
            if (e.target.closest('#add-custom-tachitte-button')) {
                const selectedIngredients = Array.from(document.querySelectorAll('.ing-checkbox:checked')).map(cb => cb.dataset.name);
                if (selectedIngredients.length > 5) {
                    showStatusMessage('Você pode selecionar no máximo 5 ingredientes.', 'error');
                    return;
                }
                if (selectedIngredients.length === 0) {
                     showStatusMessage('Selecione pelo menos um ingrediente.', 'error');
                     return;
                }
                const customTachitte = {
                    id: `custom-${Date.now()}`,
                    name: 'Tachitte Customizado',
                    description: `Com ${selectedIngredients.join(', ')}.`,
                    ingredients: selectedIngredients,
                    price: menuData.tachittes.find(t => t.isCustom).price,
                    img: 'images/customizado.png'
                };
                state.cart.push({ ...customTachitte, quantity: 1 });
                customizeModal.classList.add('hidden');
                updateCartView();
                showStatusMessage('Tachitte customizado adicionado ao carrinho!');
            }

            // Enviar pedido para o WhatsApp
            if (e.target.closest('#send-whatsapp-button')) {
                const total = parseFloat(document.getElementById('cart-total').textContent.replace('R$', ''));
                let paymentMethod = document.querySelector('input[name="payment-method"]:checked').value;
                const cardTypeRadio = document.querySelector('input[name="card-type"]:checked');
                
                if (paymentMethod === 'Cartões' && cardTypeRadio) {
                    paymentMethod += ` - ${cardTypeRadio.value}`;
                }

                if (paymentMethod === 'Dinheiro') {
                    const moneyValue = parseFloat(moneyValueInput.value);
                    if (isNaN(moneyValue) || moneyValue < total) {
                        showStatusMessage('O valor em dinheiro é insuficiente para o pagamento.', 'error');
                        return;
                    }
                    const change = moneyValue - total;
                    paymentMethod += ` (Troco para R$ ${moneyValue.toFixed(2)} - Troco de R$ ${change.toFixed(2)})`;
                }

                const deliveryAddress = document.getElementById('address').value;
                const clientPhone = document.getElementById('phone').value;
                
                let message = `Olá! Gostaria de fazer o seguinte pedido:\n\n*Pedido*\n`;

                state.cart.forEach(item => {
                    message += `- ${item.quantity}x ${item.name} (R$ ${item.price.toFixed(2)})\n`;
                    if (item.ingredients) {
                        message += `  > Ingredientes: ${item.ingredients.join(', ')}\n`;
                    }
                });
                
                message += `\n*Forma de Pedido: ${state.isDelivery ? 'Entrega' : 'Retirada'}*\n`;
                if (state.isDelivery) {
                    message += `*Taxa de Entrega: R$ ${state.deliveryFee.toFixed(2)}*\n`;
                    message += `*Endereço de Entrega: ${deliveryAddress}*\n`;
                    message += `*Telefone: ${clientPhone}*\n`;
                }

                message += `\n*Total: R$ ${total.toFixed(2)}*\n`;
                message += `*Forma de Pagamento: ${paymentMethod}*\n`;

                const whatsappUrl = `https://wa.me/${settings.whatsappNumber}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');

                // Limpa o carrinho e fecha o modal
                state.cart = [];
                updateCartView();
                checkoutModal.classList.add('hidden');
                resetCheckoutForm();
            }

            // Opções de entrega/retirada
            if (e.target.closest('#delivery-option')) {
                state.isDelivery = true;
                deliveryOptionBtn.classList.add('border-red-500', 'bg-red-500', 'text-white');
                pickupOptionBtn.classList.remove('border-red-500', 'bg-red-500', 'text-white');
                deliveryOptionBtn.classList.remove('border-red-300', 'bg-white', 'text-red-800');
                pickupOptionBtn.classList.add('border-red-300', 'bg-white', 'text-red-800');
                updateCartView();
                showStatusMessage('Opção de Entrega selecionada. Taxa de R$ 5.00 será adicionada.');
            }
            if (e.target.closest('#pickup-option')) {
                state.isDelivery = false;
                pickupOptionBtn.classList.add('border-red-500', 'bg-red-500', 'text-white');
                deliveryOptionBtn.classList.remove('border-red-500', 'bg-red-500', 'text-white');
                pickupOptionBtn.classList.remove('border-red-300', 'bg-white', 'text-red-800');
                deliveryOptionBtn.classList.add('border-red-300', 'bg-white', 'text-red-800');
                updateCartView();
                showStatusMessage('Opção de Retirada selecionada. Sem taxa adicional.');
            }

            // Alternar entre as abas
            if (e.target.closest('#salgados-tab')) {
                showTab('salgados-menu');
            }
            if (e.target.closest('#doces-tab')) {
                showTab('doces-menu');
            }
            if (e.target.closest('#bebidas-tab')) {
                showTab('bebidas-menu');
            }
            
            // Lógica para selecionar a opção de pagamento e ativar a classe 'active' e mostrar as sub-opções
            const paymentMethod = document.querySelector('input[name="payment-method"]:checked').value;
            pixInfoContainer.classList.add('hidden');
            cardSubOptionsDiv.classList.add('hidden');
            moneyChangeOptionsDiv.classList.add('hidden');
            
            if (paymentMethod === 'PIX') {
                pixInfoContainer.classList.remove('hidden');
                const currentTotal = parseFloat(document.getElementById('cart-total').textContent.replace('R$', ''));
                generatePixQRCode(currentTotal);
            } else if (paymentMethod === 'Cartões') {
                cardSubOptionsDiv.classList.remove('hidden');
            } else if (paymentMethod === 'Dinheiro') {
                moneyChangeOptionsDiv.classList.remove('hidden');
            }
            
            const paymentOptionContainer = e.target.closest('.payment-options-container > div');
            if (paymentOptionContainer) {
                 document.querySelectorAll('.payment-options-container > div').forEach(div => div.classList.remove('active'));
                 paymentOptionContainer.classList.add('active');
            }
        });
        
        // Listener para o campo de valor do dinheiro
        moneyValueInput.addEventListener('input', () => {
            const total = parseFloat(document.getElementById('cart-total').textContent.replace('R$', ''));
            const moneyValue = parseFloat(moneyValueInput.value);

            if (!isNaN(moneyValue) && moneyValue >= total) {
                const change = moneyValue - total;
                changeValueP.textContent = `Troco a ser devolvido: R$ ${change.toFixed(2)}`;
                changeValueP.classList.remove('text-red-500');
            } else if (!isNaN(moneyValue) && moneyValue < total) {
                changeValueP.textContent = 'Valor insuficiente!';
                changeValueP.classList.add('text-red-500');
            } else {
                changeValueP.textContent = '';
            }
        });

        // Adiciona um listener para o modal de checkout para impedir o fechamento em cliques internos
        checkoutModal.addEventListener('click', (e) => {
            if (e.target.closest('#close-checkout-modal')) {
                checkoutModal.classList.add('hidden');
                resetCheckoutForm();
                return;
            }
            if (e.target === checkoutModal) {
                checkoutModal.classList.add('hidden');
                resetCheckoutForm();
                return;
            }
            // Lógica para alternar a classe 'active' ao clicar em um contêiner de pagamento
            const paymentOptionContainer = e.target.closest('.payment-options-container > div');
            if (paymentOptionContainer) {
                 document.querySelectorAll('.payment-options-container > div').forEach(div => div.classList.remove('active'));
                 paymentOptionContainer.classList.add('active');
                 const radioButton = paymentOptionContainer.querySelector('.payment-method-radio');
                 if (radioButton) {
                    radioButton.checked = true;
                    // Força a execução da lógica de sub-opções
                    const event = new Event('change');
                    radioButton.dispatchEvent(event);
                 }
            }
        });
        
        // Listener para os inputs de rádio, para alternar a classe 'active' e mostrar sub-opções
        document.querySelectorAll('input[name="payment-method"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                // Remove a classe 'active' de todos
                document.querySelectorAll('.payment-options-container > div').forEach(div => div.classList.remove('active'));
                // Adiciona a classe 'active' no elemento pai do radio clicado
                e.target.closest('.payment-options-container > div').classList.add('active');

                // Esconde todas as sub-opções
                pixInfoContainer.classList.add('hidden');
                cardSubOptionsDiv.classList.add('hidden');
                moneyChangeOptionsDiv.classList.add('hidden');
                
                const selectedPaymentMethod = e.target.value;
                if (selectedPaymentMethod === 'PIX') {
                    pixInfoContainer.classList.remove('hidden');
                    const currentTotal = parseFloat(document.getElementById('cart-total').textContent.replace('R$', ''));
                    generatePixQRCode(currentTotal);
                } else if (selectedPaymentMethod === 'Cartões') {
                    cardSubOptionsDiv.classList.remove('hidden');
                } else if (selectedPaymentMethod === 'Dinheiro') {
                    moneyChangeOptionsDiv.classList.remove('hidden');
                }
            });
        });

        // Listener para o botão de copiar a chave Pix
        copyPixKeyButton.addEventListener('click', () => {
            const currentTotal = parseFloat(document.getElementById('cart-total').textContent.replace('R$', ''));
            const payload = getPixPayload(currentTotal);
            
            navigator.clipboard.writeText(payload).then(() => {
                showStatusMessage('Chave Pix copiada para a área de transferência!');
            }).catch(err => {
                console.error('Falha ao copiar a chave Pix:', err);
                showStatusMessage('Erro ao copiar a chave Pix.', 'error');
            });
        });

        // Inicializa a aplicação e registra o Service Worker
        document.addEventListener('DOMContentLoaded', () => {
            renderMenu();
            updateCartView();
            showTab('salgados-menu');

            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    const repoName = '/tachitte';
                    const swPath = `${repoName}/service-worker.js`;
                    const manifestPath = `${repoName}/manifest.json`;

                    // Altera o caminho do manifesto
                    document.querySelector('link[rel="manifest"]').href = manifestPath;

                    navigator.serviceWorker.register(swPath, { scope: repoName + '/' })
                        .then(reg => {
                            console.log('Service Worker registrado com sucesso. Escopo: ' + reg.scope);
                        }).catch(error => {
                            console.log('Falha no registro do Service Worker: ' + error);
                        });
                });
            }
        });
    </script>
</body>
</html>
